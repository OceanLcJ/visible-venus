---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import Hr from "@/components/Hr.astro";
import { getSortedPostsByLocale } from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE, LOCALE_CONFIG } from "@/config";
import { SOCIALS } from "@/constants";
import { getLocalizedPath } from "@/utils/getPath";
import type { SupportedLocale } from "@/config";

export async function getStaticPaths() {
  return [
    { params: { locale: "en" } },
    { params: { locale: "zh" } },
  ];
}

const { locale } = Astro.params as { locale: SupportedLocale };

// Get posts for the current locale
const enPosts = await getCollection("blog-en");
const zhPosts = await getCollection("blog-zh");

const posts = locale === "en" ? enPosts : zhPosts;
const sortedPosts = getSortedPostsByLocale(posts, locale);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

// Get localized config
const localeConfig = LOCALE_CONFIG[locale];
const postsPath = getLocalizedPath("posts", locale);
const rssPath = getLocalizedPath("rss.xml", locale);

// Localized content
const content = {
  en: {
    greeting: "Mingalaba",
    description: "AstroPaper is a minimal, responsive, accessible and SEO-friendly Astro blog theme. This theme follows best practices and provides accessibility out of the box. Light and dark mode are supported by default. Moreover, additional color schemes can also be configured.",
    readMore: "Read the blog posts or check",
    readmeText: "README",
    readMoreSuffix: "for more info.",
    socialLinks: "Social Links:",
    featured: "Featured",
    recentPosts: "Recent Posts",
    allPosts: "All Posts",
    rssTitle: "RSS Feed",
  },
  zh: {
    greeting: "你好",
    description: "AstroPaper 是一个极简、响应式、无障碍且SEO友好的Astro博客主题。这个主题遵循最佳实践，开箱即用地提供无障碍功能。默认支持明亮和暗黑模式。此外，还可以配置其他配色方案。",
    readMore: "阅读博客文章或查看",
    readmeText: "README",
    readMoreSuffix: "获取更多信息。",
    socialLinks: "社交链接：",
    featured: "精选文章",
    recentPosts: "最新文章",
    allPosts: "所有文章",
    rssTitle: "RSS订阅",
  },
};

const t = content[locale];
---

<Layout title={SITE.title} description={localeConfig.desc}>
  <Header />
  <main id="main-content" data-layout="index">
    <section id="hero" class="pt-8 pb-6">
      <h1 class="my-4 inline-block text-4xl font-bold sm:my-8 sm:text-5xl">
        {t.greeting}
      </h1>
      <a
        target="_blank"
        href={rssPath}
        class="inline-block"
        aria-label={t.rssTitle.toLowerCase()}
        title={t.rssTitle}
      >
        <IconRss
          width={20}
          height={20}
          class="scale-125 stroke-accent stroke-3"
        />
        <span class="sr-only">{t.rssTitle}</span>
      </a>

      <p>
        {t.description}
      </p>
      <p class="mt-2">
        {t.readMore}
        <LinkButton
          class="underline decoration-dashed underline-offset-4 hover:text-accent"
          href="https://github.com/satnaing/astro-paper#readme"
        >
          {t.readmeText}
        </LinkButton> {t.readMoreSuffix}
      </p>
      {
        // only display if at least one social link is enabled
        SOCIALS.length > 0 && (
          <div class="mt-4 flex flex-col sm:flex-row sm:items-center">
            <div class="mr-2 mb-1 whitespace-nowrap sm:mb-0">{t.socialLinks}</div>
            <Socials />
          </div>
        )
      }
    </section>

    <Hr />

    {
      featuredPosts.length > 0 && (
        <>
          <section id="featured" class="pt-12 pb-6">
            <h2 class="text-2xl font-semibold tracking-wide">{t.featured}</h2>
            <ul>
              {featuredPosts.map(data => (
                <Card variant="h3" {...data} locale={locale} />
              ))}
            </ul>
          </section>
          {recentPosts.length > 0 && <Hr />}
        </>
      )
    }

    {
      recentPosts.length > 0 && (
        <section id="recent-posts" class="pt-12 pb-6">
          <h2 class="text-2xl font-semibold tracking-wide">{t.recentPosts}</h2>
          <ul>
            {recentPosts.map(
              (data, index) =>
                index < SITE.postPerIndex && <Card variant="h3" {...data} locale={locale} />
            )}
          </ul>
        </section>
      )
    }

    <div class="my-8 text-center">
      <LinkButton href={postsPath}>
        {t.allPosts}
        <IconArrowRight class="inline-block" />
      </LinkButton>
    </div>
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      const locale = window.location.pathname.split('/')[1];
      sessionStorage.setItem("backUrl", `/${locale}/`);
    }
  });
</script>
